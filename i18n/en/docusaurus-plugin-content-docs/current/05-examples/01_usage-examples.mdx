---
id: examples
sidebar_position: 4
title: Android Examples
sidebar_label: Android Examples
---

# Android Usage Examples

## MainActivity Implementation

```kotlin
@RequiresApi(Build.VERSION_CODES.S)
class MainActivity : ComponentActivity() {
    private val klleonOndeviceSdk = KlleonOndeviceSdk()

    private val requiredPermissions = arrayOf(
        Manifest.permission.RECORD_AUDIO
    )

    private val permissionLauncher = registerForActivityResult(
        ActivityResultContracts.RequestMultiplePermissions()
    ) { permissions ->
        handlePermissionResults(permissions)
    }

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        if (checkPermissions()) {
            initializeApp()
        } else {
            requestPermissions()
        }
    }

    private fun initializeApp() {
        setContent {
            OndeviceSampleTheme {
                Surface(
                    modifier = Modifier.fillMaxSize(),
                    color = MaterialTheme.colorScheme.background
                ) {
                    WorkerScreen(klleonOndeviceSdk = klleonOndeviceSdk)
                }
            }
        }

        // Copy assets to cache directory on startup
        copyAssetToCache("loop_sample.mp4")
        copyAssetToCache("loop_sample.npz")
    }

    private fun copyAssetToCache(fileName: String) {
        try {
            val assetManager = assets
            val inputStream = assetManager.open(fileName)
            val cacheFile = File(cacheDir, fileName)

            if (!cacheFile.exists()) {
                val outputStream = FileOutputStream(cacheFile)
                inputStream.copyTo(outputStream)
                outputStream.close()
                Log.d("MainActivity", "Copied $fileName to cache: ${cacheFile.absolutePath}")
            }
            inputStream.close()
        } catch (e: IOException) {
            Log.e("MainActivity", "Error copying asset $fileName", e)
        }
    }
}
```

## Compose UI Integration

### WorkerScreen Composable

```kotlin
@RequiresApi(Build.VERSION_CODES.S)
@Composable
fun WorkerScreen(
    klleonOndeviceSdk: KlleonOndeviceSdk,
    viewModel: WorkerViewModel = viewModel()
) {
    val context = LocalContext.current
    var workerView by remember { mutableStateOf<KlleonSdkView?>(null) }
    var messageData by remember { mutableStateOf("") }

    // Asset file paths
    val vpPath = remember { File(context.cacheDir, "loop_sample.mp4").absolutePath }
    val fpPath = remember { File(context.cacheDir, "loop_sample.npz").absolutePath }

    // Collect SDK state
    val accumulatedMessages by viewModel.accumulatedMessages.collectAsState()

    LaunchedEffect(Unit) {
        viewModel.observeSdkState(klleonOndeviceSdk)
    }

    Box(
        modifier = Modifier
            .fillMaxSize()
            .padding(16.dp)
    ) {
        // Display SDK state
        Card(
            modifier = Modifier
                .align(Alignment.TopStart)
                .padding(8.dp),
            colors = CardDefaults.cardColors(
                containerColor = Color.Transparent
            )
        ) {
            Column(
                modifier = Modifier.padding(12.dp)
            ) {
                Text(
                    text = accumulatedMessages,
                    style = MaterialTheme.typography.bodySmall,
                    color = Color.Black.copy(alpha = 0.8f)
                )
            }
        }

        // Bottom content
        Column(
            modifier = Modifier
                .align(Alignment.BottomCenter)
                .fillMaxWidth(),
            verticalArrangement = Arrangement.spacedBy(16.dp)
        ) {
            // SDK View
            Card(
                modifier = Modifier
                    .fillMaxWidth()
                    .height(400.dp)
            ) {
                AndroidView(
                    factory = { context ->
                        KlleonSdkView(context).also { view ->
                            workerView = view
                            Log.d("WorkerScreen", "KlleonSdkView created: $view")
                        }
                    },
                    modifier = Modifier.fillMaxSize()
                )
            }

            // Message input
            OutlinedTextField(
                value = messageData,
                onValueChange = { messageData = it },
                label = { Text("Message") },
                modifier = Modifier.fillMaxWidth()
            )

            // Control buttons
            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.spacedBy(8.dp)
            ) {
                Button(
                    onClick = {
                        workerView?.let { view ->
                            Log.d("WorkerScreen", "workerPlay $vpPath $fpPath $view")
                            klleonOndeviceSdk.play(
                                context as ComponentActivity, 
                                view, 
                                vpPath, 
                                fpPath,
                                "SDK KEY"
                            )
                        }
                    },
                    modifier = Modifier.weight(1f),
                    enabled = workerView != null
                ) {
                    Text("Play")
                }

                Button(
                    onClick = { klleonOndeviceSdk.finish() },
                    modifier = Modifier.weight(1f)
                ) {
                    Text("Stop")
                }
            }

            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.spacedBy(8.dp)
            ) {
                Button(
                    onClick = {
                        try {
                            klleonOndeviceSdk.sendMessage(messageData)
                        } catch (e: Exception) {
                            Log.e("WorkerScreen", "Message send error", e)
                        }
                    },
                    modifier = Modifier.weight(1f)
                ) {
                    Text("Send Message")
                }

                Button(
                    onClick = {
                        try {
                            klleonOndeviceSdk.sendMessageEcho(messageData)
                        } catch (e: Exception) {
                            Log.e("WorkerScreen", "Echo send error", e)
                        }
                    },
                    modifier = Modifier.weight(1f)
                ) {
                    Text("Echo")
                }
            }
        }
    }
}
```

## ViewModel Implementation

### WorkerViewModel

```kotlin
@RequiresApi(Build.VERSION_CODES.S)
class WorkerViewModel : ViewModel() {
    
    private val _accumulatedMessages = MutableStateFlow("")
    val accumulatedMessages: StateFlow<String> = _accumulatedMessages.asStateFlow()

    fun observeSdkState(klleonOndeviceSdk: KlleonOndeviceSdk) {
        viewModelScope.launch {
            klleonOndeviceSdk.sdkState.collect { state ->
                state.let {
                    val messageToAdd = try {
                        val json = JSONObject(state)
                        json.getString("message")
                    } catch (t: Throwable) {
                        state.toString()
                    }
                    
                    // Add new message to accumulated messages
                    if (messageToAdd.isNotBlank()) {
                        val currentMessages = _accumulatedMessages.value
                        val newMessages = if (currentMessages.isEmpty()) {
                            messageToAdd
                        } else {
                            "$currentMessages\n$messageToAdd"
                        }
                        _accumulatedMessages.value = newMessages
                    }
                }
            }
        }
    }
    
    fun clearMessages() {
        _accumulatedMessages.value = ""
    }
}
```

## Minimal Integration Example

For simple implementation:

```kotlin
@RequiresApi(Build.VERSION_CODES.S)
@Composable
fun SimpleSDKIntegration() {
    val context = LocalContext.current
    val klleonOndeviceSdk = remember { KlleonOndeviceSdk() }
    var sdkView by remember { mutableStateOf<KlleonSdkView?>(null) }
    
    Column(
        modifier = Modifier
            .fillMaxSize()
            .padding(16.dp)
    ) {
        // SDK View
        AndroidView(
            factory = { context ->
                KlleonSdkView(context).also { view ->
                    sdkView = view
                }
            },
            modifier = Modifier
                .fillMaxWidth()
                .weight(1f)
        )
        
        // Play button
        Button(
            onClick = {
                sdkView?.let { view ->
                    val videoPath = File(context.cacheDir, "loop_sample.mp4").absolutePath
                    val facialPath = File(context.cacheDir, "loop_sample.npz").absolutePath
                    
                    klleonOndeviceSdk.play(
                        context as ComponentActivity,
                        view,
                        videoPath,
                        facialPath,
                        "SDK key"
                    )
                }
            },
            modifier = Modifier.fillMaxWidth(),
            enabled = sdkView != null
        ) {
            Text("Start SDK")
        }
    }
}
```

## State Observation Pattern

```kotlin
@Composable
fun SDKStateObserver(klleonOndeviceSdk: KlleonOndeviceSdk) {
    var currentState by remember { mutableStateOf("") }
    
    LaunchedEffect(klleonOndeviceSdk) {
        klleonOndeviceSdk.sdkState.collect { state ->
            currentState = try {
                val json = JSONObject(state)
                "State: ${json.getString("message")}"
            } catch (e: Exception) {
                "Raw state: $state"
            }
        }
    }
    
    Text(
        text = currentState,
        modifier = Modifier.padding(16.dp)
    )
}
```

## Error Handling Pattern

```kotlin
class SDKManager {
    private val klleonOndeviceSdk = KlleonOndeviceSdk()
    
    fun safePlay(
        activity: ComponentActivity,
        view: KlleonSdkView,
        videoPath: String,
        facialPath: String,
        sdkKey: String
    ): Boolean {
        return try {
            // Input validation
            if (!File(videoPath).exists()) {
                Log.e("SDKManager", "Video file not found: $videoPath")
                return false
            }
            
            if (!File(facialPath).exists()) {
                Log.e("SDKManager", "Facial file not found: $facialPath")
                return false
            }
            
            klleonOndeviceSdk.play(activity, view, videoPath, facialPath, sdkKey)
            Log.d("SDKManager", "SDK playback started successfully")
            true
        } catch (e: Exception) {
            Log.e("SDKManager", "Failed to start SDK playback", e)
            false
        }
    }
    
    fun safeSendMessage(message: String): Boolean {
        return try {
            if (message.isBlank()) {
                Log.w("SDKManager", "Attempted to send empty message")
                return false
            }
            
            klleonOndeviceSdk.sendMessage(message)
            Log.d("SDKManager", "Message sent: $message")
            true
        } catch (e: Exception) {
            Log.e("SDKManager", "Failed to send message", e)
            false
        }
    }
}
```
